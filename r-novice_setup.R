if (dir.exists(paste(getwd(), "/_episodes_rmd/", sep=''))) {
    epdir <- paste(getwd(), "/_episodes_rmd/", sep='')
} else if (dir.exists(paste(getwd(), "/collections/_episodes_rmd/r-novice/", sep=''))) {
    epdir <- paste(getwd(), "/collections/_episodes_rmd/r-novice/", sep='')
}

data_raw_path <- paste(getwd(), "/data_raw/", sep='')
## file structure
if (!dir.exists(data_raw_path)) dir.create(data_raw_path)

if (!file.exists("data_raw/surveys.csv")) {
    download.file("https://ndownloader.figshare.com/files/2292172",
                  "data_raw/surveys.csv")
}
if (!file.exists("data_raw/species.csv")) {
    download.file("https://ndownloader.figshare.com/files/3299483",
                  "data_raw/species.csv")
}
if (!file.exists("data_raw/plots.csv")) {
    download.file("https://ndownloader.figshare.com/files/3299474",
                  "data_raw/plots.csv")
}
if (!file.exists("data_raw/portal_data_joined.csv")) {
    download.file("https://ndownloader.figshare.com/files/2292169",
                  "data_raw/portal_data_joined.csv")
}

if (!file.exists("data_raw/portal_mammals.sqlite")) {
    download.file("https://ndownloader.figshare.com/files/2292171",
                  "data_raw/portal_mammals.sqlite")
}


## knitr options
library(knitr)
library(methods)
library(shiny)
suppressPackageStartupMessages(library(tidyverse))
knitr::opts_chunk$set(results='hide', comment = "#>", purl = FALSE, fig.keep='last')

base_url <- "/" # keep as is
fig_path <- "fig/" # Output path for figures

# If the document is currently being knit, do this; skip it in normal execution
if (!is.null(knitr::current_input())){
  # Set base directories
  knitr::opts_knit$set(base.url = base_url)

  # Set figure directories
  knitr::opts_chunk$set(fig.path = fig_path,
                      cache.path = '../cache/',
                      message=FALSE, warning=FALSE,
                      cache = FALSE)
}


### Custom hooks
## hook for challenges answers

# If we are in an answer block indent by one
hook_source <- knitr::knit_hooks$get("source")  # save the old hook
knitr::knit_hooks$set(source = function(x, options) {
    if (isTruthy(options$answer)) {
        paste(c('> ## Solution',
                '>',
                paste('> ', xfun::split_lines(x), sep = ''),
                '{: .solution}'), sep = '', collapse = '\n')
} else {
        hook_source(x, options)
    }
})

# knitr::knit_hooks$set(answer = function(before, options, envir) {
#     if (before) {
#     paste(
#         "> ## Solution \n",
#         "> > \n",
#         sep = "")
#     } else {
#     paste(
#         "{: .solution}\n",
#         sep = "")
#     }
# })

eng_text_answer <- knitr:::eng_html_asset(
                                paste(
                                    "## Solution",
                                    sep = "\n"),
                                paste(
                                    "{: .solution}",
                                    sep = "\n")
                            )

knitr::knit_engines$set(text_answer = eng_text_answer)

library(needs)
prioritize(dplyr)